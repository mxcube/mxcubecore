---


name: "Pages"

concurrency:
  group: "pages"

on:
  push:
  pull_request:

jobs:

  "pages-build":

    runs-on: "ubuntu-22.04"

    steps:

      - name: "Checkout"
        uses: "actions/checkout@v4"  # tested with v4.1.0

      - name: "Setup conda environment with micromamba"
        uses: "mamba-org/setup-micromamba@v1"
        with:
          cache-environment: true
          environment-file: "conda-environment-dev.yml"
          post-cleanup: "all"

      - name: "Install dependencies with Poetry"
        run: "${MAMBA_EXE} run --name mxcubecore poetry install --only=docs,main"

      - name: "Build documentation with Sphinx"
        run: "${MAMBA_EXE} run --name mxcubecore make --directory=./docs/ html"

      - name: "Upload artifact for GitHub Pages"
        # This could potentially be run only when we intend to deploy...
        # ...but it can be useful to have the artifact for debugging
        # if: "github.ref_name == github.event.repository.default_branch"
        uses: "actions/upload-pages-artifact@v3"
        with:
          path: "docs/build/html"

  "pages-deploy":

    if: "github.ref_name == github.event.repository.default_branch"

    environment:
      name: "github-pages"
      url: "${{ steps.deployment.outputs.page_url }}"

    needs:
      - "pages-build"

    permissions:
      pages: "write"
      id-token: "write"

    runs-on: "ubuntu-22.04"

    steps:

      - name: "Setup GitHub Pages"
        uses: "actions/configure-pages@v4"

      - name: "Deploy to GitHub Pages"
        id: "deployment"
        uses: "actions/deploy-pages@v4"


...  # EOF
